<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Riviera 53 - Fleet Command</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #001f3f; padding: 10px; color: #333; margin: 0; }
        .card { background: white; padding: 20px; border-radius: 25px; max-width: 480px; margin: 10px auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .tab-container { display: flex; background: #002b55; border-radius: 12px; margin-bottom: 20px; padding: 5px; gap: 5px; }
        .tab { flex: 1; text-align: center; padding: 12px 5px; color: white; cursor: pointer; border-radius: 8px; font-size: 11px; font-weight: bold; transition: 0.3s; }
        .tab.active { background: white; color: #001f3f; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        h2 { color: #004080; text-align: center; margin-bottom: 15px; font-size: 18px; text-transform: uppercase; }
        label { display: block; margin-top: 10px; font-weight: 600; font-size: 11px; color: #666; text-transform: uppercase; }
        input, select { width: 100%; padding: 12px; margin-top: 5px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-size: 16px; font-weight: bold; }
        .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 14px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-blue { background: #005a9c; color: white; }
        .btn-orange { background: #e67e22; color: white; margin-top: 15px; }
        .footer { font-size: 9px; color: #aaa; text-align: center; margin-top: 20px; }
        /* Modal Style */
        #refModal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); overflow-y: auto; }
        .modal-content { background: white; margin: 5% auto; padding: 20px; border-radius: 20px; width: 90%; max-width: 400px; font-size: 12px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background: #001f3f; color: white; }
    </style>
</head>
<body>

<div class="card">
    <div class="tab-container">
        <div id="tab-logbook" class="tab active" onclick="switchTab('logbook')">LOGBOOK</div>
        <div id="tab-auditor" class="tab" onclick="switchTab('auditor')">AUDITOR</div>
        <div id="tab-range" class="tab" onclick="switchTab('range')">RANGE PRO</div>
    </div>

    <div id="logbook" class="tab-content active">
        <h2>BitÃ¡cora de Gastos</h2>
        <label>Seleccionar Viaje:</label>
        <select id="tripSelect" onchange="updateTotalDisplay()">
            <option value="">Cargando historial...</option>
        </select>
        
        <div style="background: #eef6ff; padding: 15px; border-radius: 15px; margin-top: 15px; border: 2px solid #004080; text-align: center;">
            <span style="font-size:11px; font-weight:bold; color:#004080;">TOTAL ACUMULADO:</span>
            <span id="displayTotal" style="font-size: 28px; font-weight: bold; color: #d9534f; display: block;">$0.00</span>
        </div>

        <div style="border-top: 1px solid #eee; margin-top: 20px; padding-top: 10px;">
            <label>Nuevo Destino:</label>
            <input type="text" id="newTripDest" placeholder="Ej: Culebra">
            <button class="btn btn-blue" onclick="createNewTrip()">ðŸš€ CREAR EXPEDICIÃ“N</button>
        </div>

        <div style="border-top: 1px solid #eee; margin-top: 20px; padding-top: 10px;">
            <label>Monto del Gasto ($):</label>
            <input type="number" id="monto" placeholder="0.00" inputmode="decimal">
            <button class="btn btn-orange" onclick="addExpense()">âž• REGISTRAR GASTO</button>
        </div>
    </div>

    <div id="auditor" class="tab-content">
        <h2>Confirmar Consumo</h2>
        <label>Galones:</label><input type="number" id="galReal" oninput="calcFuelAudit()">
        <label>Horas:</label><input type="number" id="hrsReal" oninput="calcFuelAudit()">
        <div style="text-align:center; margin-top:20px; font-size:30px; font-weight:bold;" id="resGPH">0.0 GPH</div>
    </div>

    <div id="range" class="tab-content">
        <button onclick="toggleModal(true)" style="float:right; background:#005a9c; color:white; border:none; padding:5px 10px; border-radius:10px; font-size:10px;">ðŸ“Š REF</button>
        <h2>Safe Range Pro</h2>
        <label>Combustible Actual:</label><input type="number" id="fuelRange" oninput="calculateRange()">
        <label>Consumo Total (GPH):</label><input type="number" id="gphTotal" oninput="calculateRange()">
        <label>Velocidad (Knots):</label><input type="number" id="knotsRange" oninput="calculateRange()">
        <div style="text-align:center; margin-top:20px; font-size:40px; font-weight:bold; color:#2ecc71;" id="resRange">0 NM</div>
    </div>

    <div class="footer">Casco: RIY53032D415 | Fleet Command v9.3</div>
</div>

<div id="refModal">
    <div class="modal-content">
        <h3 style="color:#004080; margin-top:0; text-align:center;">ðŸ“ˆ Tabla de Rendimiento</h3>
        <table>
            <thead><tr><th>RPM</th><th>Kts</th><th>GPH</th></tr></thead>
            <tbody>
                <tr><td>1500</td><td>12.0</td><td>22.0</td></tr>
                <tr style="background:#eef6ff; font-weight:bold; color:#005a9c;"><td>2100</td><td>24.8</td><td>51.0</td></tr>
                <tr><td>2500</td><td>33.5</td><td>74.0</td></tr>
            </tbody>
        </table>
        <button onclick="toggleModal(false)" style="width:100%; padding:12px; background:#d9534f; color:white; border:none; border-radius:10px; margin-top:15px; font-weight:bold;">CERRAR</button>
    </div>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyZEmBTB7xtMUngAfG3RmfKSwNhrLibrbe1WejAmyUNwzfPolDiRKyeWyvGt2rCKsS1/exec';
    let listaViajes = [];

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.getElementById('tab-' + tabId).classList.add('active');
    }

    function toggleModal(show) { document.getElementById('refModal').style.display = show ? 'block' : 'none'; }

    // CARGAR DATOS DESDE GOOGLE SHEETS
    async function cargarViajes(nombreASeleccionar = null) {
        try {
            const response = await fetch(scriptURL);
            listaViajes = await response.json();
            const select = document.getElementById('tripSelect');
            select.innerHTML = '<option value="">-- Selecciona un viaje --</option>';
            listaViajes.forEach(v => {
                select.innerHTML += `<option value="${v.nombre}">${v.nombre}</option>`;
            });
            if (nombreASeleccionar) {
                select.value = nombreASeleccionar;
                updateTotalDisplay();
            }
        } catch (e) {
            document.getElementById('tripSelect').innerHTML = '<option>Error al conectar</option>';
        }
    }

    function updateTotalDisplay() {
        const nombre = document.getElementById('tripSelect').value;
        const viaje = listaViajes.find(v => v.nombre === nombre);
        document.getElementById('displayTotal').innerText = viaje ? `$${viaje.total.toFixed(2)}` : "$0.00";
    }

    async function addExpense() {
        const name = document.getElementById('tripSelect').value;
        const monto = parseFloat(document.getElementById('monto').value);
        if(!name || !monto) return alert("Selecciona viaje y pon monto");
        
        await fetch(scriptURL, { 
            method: 'POST', 
            mode: 'no-cors', 
            body: JSON.stringify({ type: "GASTO_DETALLE", tripName: name, monto: monto, fecha: new Date().toISOString().split('T')[0] }) 
        });
        
        alert("âœ… Gasto registrado");
        document.getElementById('monto').value = "";
        setTimeout(cargarViajes, 2000); // Recarga para actualizar total
    }

    // Ejecutar carga al abrir la app
    window.onload = cargarViajes;
</script>
</body>
</html>
